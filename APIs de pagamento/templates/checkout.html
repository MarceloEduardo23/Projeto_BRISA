<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finalizar Compra</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .payment-method-option.selected { border-color: #2563eb !important; box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2); }
        .input-error { border-color: #ef4444 !important; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen py-8 lg:py-12">
        <div class="max-w-6xl mx-auto px-4">
            <div class="grid lg:grid-cols-2 gap-8 lg:gap-12">
                <div class="space-y-6">
                    <div class="rounded-lg border bg-white text-gray-800 shadow-sm">
                        <div class="p-6"><h3 class="text-xl font-semibold">Informações Pessoais</h3></div>
                        <div class="p-6 pt-0 space-y-4">
                            <div class="grid sm:grid-cols-2 gap-4">
                                <div>
                                    <label for="firstName" class="text-sm font-medium">Nome</label>
                                    <input id="firstName" placeholder="João" class="mt-1 flex h-10 w-full rounded-md border border-gray-300 bg-transparent px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                </div>
                                <div>
                                    <label for="lastName" class="text-sm font-medium">Sobrenome</label>
                                    <input id="lastName" placeholder="Silva" class="mt-1 flex h-10 w-full rounded-md border border-gray-300 bg-transparent px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                </div>
                            </div>
                            <div>
                                <label for="email" class="text-sm font-medium">Email</label>
                                <input id="email" type="email" placeholder="joao@exemplo.com" class="mt-1 flex h-10 w-full rounded-md border border-gray-300 bg-transparent px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                            </div>
                            <div>
                                <label for="phone" class="text-sm font-medium">Telefone</label>
                                <input id="phone" placeholder="(11) 99999-9999" class="mt-1 flex h-10 w-full rounded-md border border-gray-300 bg-transparent px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                            </div>
                             <div>
                                <label for="document" class="text-sm font-medium">CPF</label>
                                <input id="document" placeholder="000.000.000-00" class="mt-1 flex h-10 w-full rounded-md border border-gray-300 bg-transparent px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                            </div>
                        </div>
                    </div>
                    <div class="rounded-lg border bg-white text-gray-800 shadow-sm">
                        <div class="p-6"><h3 class="text-xl font-semibold">Endereço de Entrega</h3></div>
                        <div class="p-6 pt-0 space-y-4">
                            <div>
                                <label for="zipCode" class="text-sm font-medium">CEP</label>
                                <input id="zipCode" placeholder="01234-567" class="mt-1 flex h-10 w-full rounded-md border border-gray-300 bg-transparent px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                            </div>
                            <div>
                                <label for="address" class="text-sm font-medium">Endereço</label>
                                <input id="address" placeholder="Rua das Flores, 123" class="mt-1 flex h-10 w-full rounded-md border border-gray-300 bg-transparent px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                            </div>
                        </div>
                    </div>
                    <div class="rounded-lg border bg-white text-gray-800 shadow-sm">
                        <div class="p-6"><h3 class="text-xl font-semibold">Método de Pagamento</h3></div>
                        <div class="p-6 pt-0">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm font-medium text-center">
                                <label for="card" class="payment-method-option flex flex-col items-center justify-center rounded-md border-2 border-gray-300 p-4 hover:bg-gray-50 cursor-pointer transition-all">
                                    <input type="radio" name="paymentMethod" value="card" id="card" class="sr-only" />
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mb-2 h-6 w-6"><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></svg>
                                    Cartão (MP)
                                </label>
                                <label for="paypal" class="payment-method-option flex flex-col items-center justify-center rounded-md border-2 border-gray-300 p-4 hover:bg-gray-50 cursor-pointer transition-all">
                                    <input type="radio" name="paymentMethod" value="paypal" id="paypal" class="sr-only" />
                                    <svg class="mb-2 h-6 w-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M7.076 21.337a.999.999 0 0 1-.943-.684l-1.748-8.23a1 1 0 0 1 .944-1.316h3.428c.323 0 .636.136.855.379l.745.83a1 1 0 0 0 .783.378h.823c.47 0 .868.342.97.803l1.205 5.423a1.002 1.002 0 0 1-.97 1.197h-2.99a1 1 0 0 1-.855-.379l-.745-.83a1 1 0 0 0-.783-.378h-.902l-.248 1.167c-.126.59-.654.996-1.246.996zm12.3-13.315c-.19-.844-.823-1.445-1.62-1.445h-3.428c-.323 0-.636-.136-.855-.379l-.745-.83a1 1 0 0 0-.783-.378h-.822c-.47 0-.868-.342-.97-.803L9.24 1.196a1 1 0 0 0-.97-1.196H4.842c-.47 0-.868.342-.97.803L2.666 6.226a1 1 0 0 0 .97 1.196h2.99c.323 0 .636.136.855.379l.745.83a1 1 0 0 0 .783.378h.823c.47 0 .868.342.97.803l1.204 5.423a1 1 0 0 0 .97 1.197h3.428c.797 0 1.43-.6 1.62-1.445l2.45-10.923a1.002 1.002 0 0 0-.173-.996z"/></svg>
                                    PayPal
                                </label>
                                <label for="pix" class="payment-method-option flex flex-col items-center justify-center rounded-md border-2 border-gray-300 p-4 hover:bg-gray-50 cursor-pointer transition-all">
                                    <input type="radio" name="paymentMethod" value="pix" id="pix" class="sr-only" />
                                    <svg class="mb-2 h-6 w-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 48 48"><path stroke-linejoin="round" stroke-width="4" d="M24 44c11.046 0 20-8.954 20-20S35.046 4 24 4 4 12.954 4 24s8.954 20 20 20Z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="m17 19 5-5 5 5m-5 15v-5m0-10v-5m-5 15 5-5 5 5"/></svg>
                                    PIX
                                </label>
                                <label for="stripe" class="payment-method-option flex flex-col items-center justify-center rounded-md border-2 border-gray-300 p-4 hover:bg-gray-50 cursor-pointer transition-all">
                                    <input type="radio" name="paymentMethod" value="stripe" id="stripe" class="sr-only" checked />
                                    <svg class="mb-2 h-6 w-6" viewBox="0 0 82 34" fill="#635BFF" xmlns="http://www.w3.org/2000/svg"><path d="M68.832 17.001c0-4.48-3.328-8.06-7.584-8.06-4.48 0-7.712 3.58-7.712 8.06 0 4.256 3.008 8.06 7.712 8.06 4.256 0 7.584-3.804 7.584-8.06zM64.92 17c0 2.24-1.456 4-3.696 4-2.24 0-3.696-1.76-3.696-4 0-2.24 1.456-4 3.696-4 2.24 0 3.696 1.76 3.696 4zm-21.896-7.836h3.008l-3.92 15.672h-2.9L35.296 9.165h3.096l1.632 8.736 1.632-8.736zM71.016 9.165h2.896v15.672h-2.896V9.165zm10.744 0h3.216l-4.816 15.672h-3.44l4.04-15.672zM28.84 9.165l-4.592 11.248-1.52-4.48h-3.008l3.696 11.36h3.008l6.304-15.72h-3.888zM18.84 9.165h-2.896v15.672h2.896V9.165zm-7.072 0H8.964v15.672h2.896V12.173L14.764 24.837h2.064l2.9-12.664v12.664h2.896V9.165H19.4L15.82 20.341l-4.056-11.176z" fill="#635BFF"></path></svg>
                                    Cartão (Stripe)
                                </label>
                            </div>
                            <div id="card-details" class="payment-details mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg hidden">
                                <p class="text-sm text-blue-800">Você será redirecionado para o ambiente seguro do Mercado Pago para pagar com Cartão de Crédito.</p>
                            </div>
                            <div id="pix-details" class="payment-details mt-6 p-4 bg-green-50 border border-green-200 rounded-lg hidden">
                                <p class="text-sm text-green-800">Você será redirecionado para o Mercado Pago para pagar com o QR Code ou código PIX.</p>
                            </div>
                            <div id="paypal-details" class="payment-details mt-6 p-4 bg-sky-50 border border-sky-200 rounded-lg hidden">
                                <p class="text-sm text-sky-800">Você será redirecionado para o site seguro do PayPal para completar seu pagamento.</p>
                            </div>
                            <div id="stripe-details" class="payment-details mt-6 p-4 bg-indigo-50 border border-indigo-200 rounded-lg hidden">
                                <p class="text-sm text-indigo-800">Você será redirecionado para a página segura do Stripe para completar o pagamento.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:sticky top-12 self-start">
                    <div class="rounded-lg border bg-white text-gray-800 shadow-sm">
                        <div class="p-6"><h3 class="text-xl font-semibold">Resumo do Pedido</h3></div>
                        <div class="p-6 pt-0 space-y-4">
                            <div id="order-items-list" class="space-y-3"></div>
                            <div class="border-t border-gray-200 my-4"></div>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between"><span class="text-gray-600">Subtotal</span><span id="subtotal-display" class="font-medium">R$ 0,00</span></div>
                                <div class="flex justify-between"><span class="text-gray-600">Impostos</span><span id="tax-display" class="font-medium">R$ 0,00</span></div>
                                <div class="border-t border-gray-200 my-4"></div>
                                <div class="flex justify-between font-bold text-lg"><span>Total</span><span id="total-display">R$ 0,00</span></div>
                            </div>
                            <div class="p-6 pt-2">
                                <form id="checkout-form-main" class="w-full">
                                    <button type="submit" id="submit-button" class="inline-flex items-center justify-center rounded-md text-sm font-medium h-11 px-8 w-full bg-gray-900 text-white hover:bg-gray-800 disabled:opacity-50">
                                        Finalizar Compra
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        let orderItems = [];
        const checkoutForm = document.getElementById('checkout-form-main');
        const submitButton = document.getElementById('submit-button');
        const paymentMethodRadios = document.querySelectorAll('input[name="paymentMethod"]');

        // FUNÇÃO PARA ATUALIZAR O RESUMO DO PEDIDO (substitua pela sua se for diferente)
        function updateOrderSummary() {
            const itemsList = document.getElementById('order-items-list');
            const subtotalDisplay = document.getElementById('subtotal-display');
            const taxDisplay = document.getElementById('tax-display');
            const totalDisplay = document.getElementById('total-display');
            
            let subtotal = 0;
            itemsList.innerHTML = '';
            
            orderItems.forEach(item => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex justify-between items-center text-sm';
                itemDiv.innerHTML = `
                    <div>
                        <p class="font-medium text-gray-800">${item.name} (Qtd: ${item.quantity})</p>
                    </div>
                    <p class="font-medium">R$ ${itemTotal.toFixed(2)}</p>`;
                itemsList.appendChild(itemDiv);
            });
            
            const tax = subtotal * 0.08;
            const total = subtotal + tax;

            subtotalDisplay.textContent = `R$ ${subtotal.toFixed(2)}`;
            taxDisplay.textContent = `R$ ${tax.toFixed(2)}`;
            totalDisplay.textContent = `R$ ${total.toFixed(2)}`;
        }

        // FUNÇÃO PARA GERENCIAR A EXIBIÇÃO DAS DESCRIÇÕES
        function showPaymentMethodDetails(selectedMethod) {
            document.querySelectorAll('.payment-details').forEach(block => block.classList.add('hidden'));
            document.querySelectorAll('.payment-method-option').forEach(opt => opt.classList.remove('selected'));
            
            const detailsBlock = document.getElementById(`${selectedMethod}-details`);
            if (detailsBlock) {
                detailsBlock.classList.remove('hidden');
            }
            
            const label = document.querySelector(`label[for="${selectedMethod}"]`);
            if (label) {
                label.classList.add('selected');
            }
        }

        // EVENT LISTENER PARA A TROCA DE MÉTODO DE PAGAMENTO
        paymentMethodRadios.forEach(radio => {
            radio.addEventListener('change', (event) => {
                showPaymentMethodDetails(event.target.value);
            });
        });

        // EVENT LISTENER DO FORMULÁRIO (CORRIGIDO E COMPLETO)
        checkoutForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            submitButton.disabled = true;
            submitButton.innerHTML = '<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>';

            // ESTA PARTE É FUNDAMENTAL: Monta o payload com os dados do formulário
            const payload = {
                payment_method: document.querySelector('input[name="paymentMethod"]:checked').value,
                user_data: {
                    first_name: document.getElementById('firstName').value.trim(),
                    last_name: document.getElementById('lastName').value.trim(),
                    email: document.getElementById('email').value.trim(),
                    phone: document.getElementById('phone').value.trim().replace(/\D/g, ''),
                    document_number: document.getElementById('document').value.trim().replace(/\D/g, ''),
                    address: document.getElementById('address').value.trim(),
                    zip_code: document.getElementById('zipCode').value.trim().replace(/\D/g, ''),
                },
                items: orderItems
            };

            // Validação simples
            if (!payload.user_data.first_name || !payload.user_data.email) {
                alert("Por favor, preencha pelo menos o nome e o e-mail.");
                submitButton.disabled = false;
                submitButton.textContent = "Finalizar Compra";
                return;
            }

            try {
                const response = await fetch('/create_payment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (response.ok) {
                    const redirectUrl = result.redirect_url || result.init_point || result.approval_url;
                    if (redirectUrl) {
                        window.location.href = redirectUrl;
                    } else {
                        throw new Error("URL de redirecionamento não recebida.");
                    }
                } else {
                    throw new Error(result.mensagem || 'Ocorreu um erro ao gerar o pagamento.');
                }
            } catch (error) {
                alert(error.message);
                submitButton.disabled = false;
                submitButton.textContent = "Finalizar Compra";
            }
        });

        // INICIALIZAÇÃO DA PÁGINA
        const storedItems = localStorage.getItem('checkoutItems');
        if (storedItems) {
            orderItems = JSON.parse(storedItems);
            updateOrderSummary();
        } else {
            document.getElementById('order-items-list').innerHTML = '<p class="text-sm text-gray-500">Seu carrinho está vazio.</p>';
            submitButton.disabled = true;
        }
        
        // Garante que a descrição correta seja exibida ao carregar a página
        const defaultMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
        showPaymentMethodDetails(defaultMethod);
    });
    </script>
</body>
</html>